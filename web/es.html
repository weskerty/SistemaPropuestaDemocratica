<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paraguay Libre - Propuestas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>
    <link rel="stylesheet" href="estilo.css">
</head>
<body>
    <div id="app">
        <h1>âœ¨ Lista de Propuestas âœ¨</h1>
        <div class="grid-gallery" id="issues-grid">
            <p>âŒ› Cargando propuestas...</p>
        </div>
    </div>

    <div id="issue-detail" style="display:none;">
        <button class="back-button" onclick="vL()">â† Volver a la Lista</button>
        <div id="issue-content"></div>
        <div id="issue-comments"></div>
    </div>

    <script>
        const O = 'weskerty';
        const R = 'SistemaPropuestaDemocratica';
        const A = `https://api.github.com/repos/${O}/${R}`;
        let D = [];
        let C = {};
        let md;

        window.addEventListener('load', () => {
            md = window.markdownit({html: true, breaks: true, linkify: true});
            lI();
        });

        async function lI() {
            try {
                const r = await fetch(`${A}/issues?state=open&per_page=100`);
                if (!r.ok) throw new Error(`Error: ${r.status}`);
                D = await r.json();
                rG();
            } catch (e) {
                document.getElementById('issues-grid').innerHTML = `<p>Error: ${e.message}</p>`;
            }
        }

        function eI(b) {
            if (!b) return null;
            const m = b.match(/!\[.*?\]\((.*?)\)/);
            return m ? m[1] : null;
        }

        function rG() {
            const g = document.getElementById('issues-grid');
            if (D.length === 0) {
                g.innerHTML = '<p>No hay propuestas abiertas</p>';
                return;
            }
            
            g.innerHTML = D.map(i => {
                const img = eI(i.body);
                return `
                    <div class="issue-card" onclick="vI(${i.number})">
                        ${img ? `<img src="${img}" alt="${i.title}" loading="lazy" />` : `<div class="placeholder">${i.title}</div>`}
                        <div class="issue-title">${i.title}</div>
                    </div>
                `;
            }).join('');
        }

        async function vI(n) {
            document.getElementById('app').style.display = 'none';
            document.getElementById('issue-detail').style.display = 'block';
            
            const i = D.find(x => x.number === n);
            if (!i) return;
            
            const ic = document.getElementById('issue-content');
            ic.innerHTML = `<p>âŒ› Cargando detalles...</p>`;
            
            if (!C[n]) {
                try {
                    const [cm, rc] = await Promise.all([
                        fetch(`${A}/issues/${n}/comments`).then(r => r.json()),
                        fetch(`${A}/issues/${n}/reactions`, {
                            headers: {'Accept': 'application/vnd.github.squirrel-girl-preview+json'}
                        }).then(r => r.json())
                    ]);
                    
                    C[n] = {i: i, c: cm, r: rc};
                } catch (e) {
                    ic.innerHTML = `<p>Error: ${e.message}</p>`;
                    return;
                }
            }
            
            rD(n);
        }

        function rD(n) {
            const {i, c, r} = C[n];
            
            const rc = {};
            r.forEach(x => rc[x.content] = (rc[x.content] || 0) + 1);
            
            const re = Object.entries(rc).map(([k, v]) => {
                const e = {'heart': 'â¤ï¸', 'thumbs_up': 'ğŸ‘', 'thumbs_down': 'ğŸ‘', 'laugh': 'ğŸ˜„', 'hooray': 'ğŸ‰', 'confused': 'ğŸ˜•', 'rocket': 'ğŸš€', 'eyes': 'ğŸ‘€'}[k] || k;
                return `${e} ${v}`;
            }).join(' ');
            
            document.getElementById('issue-content').innerHTML = `
                <h1>${i.title}</h1>
                <p style="color:#888;">Por <a href="https://github.com/${i.user.login}" target="_blank" style="color:#58a6ff;text-decoration:none;">${i.user.login}</a> Â· Issue #${i.number} Â· ğŸ’¬ ${i.comments} comentarios</p>
                ${re ? `<div class="reactions-bar"><strong>Votado:</strong> ${re}</div>` : ''}
                <div class="markdown-content">${md.render(i.body || '')}</div>
            `;
            
            const cm = document.getElementById('issue-comments');
            if (c.length === 0) {
                cm.innerHTML = '<h2>Sin comentarios aÃºn</h2>';
            } else {
                cm.innerHTML = `
                    <h2>Comentarios (${c.length})</h2>
                    ${c.map(x => `
                        <div class="rss-item">
                            <h3><a href="https://github.com/${x.user.login}" target="_blank">${x.user.login}</a></h3>
                            <div class="markdown-content">${md.render(x.body)}</div>
                        </div>
                    `).join('')}
                `;
            }
            
            cm.innerHTML += `
                <div style="text-align:center;margin-top:30px;">
                    <a href="https://github.com/weskerty/SistemaPropuestaDemocratica/issues/new" target="_blank" style="display:inline-block;padding:12px 24px;background:#1a73e8;color:white;text-decoration:none;border-radius:6px;font-weight:bold;">Crear Nueva Propuesta</a>
                </div>
            `;
        }

        function vL() {
            document.getElementById('issue-detail').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            window.scrollTo({top: 0, behavior: 'smooth'});
        }
    </script>
</body>
</html>
